#### Table of contents
(toc generated by [ghtoc](https://github.com/sk1418/ghtoc))
- [详细设计说明书](#详细设计说明书)
- [1.引言](#1.引言)
    - [1.1 编写目的](#1.1-编写目的)
    - [1.2 背景](#1.2-背景)
    - [1.3 定义](#1.3-定义)
    - [1.4 参考资料](#1.4-参考资料)
- [2. 程序系统的结构](#2.-程序系统的结构)
- [3. 程序 1 设计说明](#3.-程序-1-设计说明)
    - [主程序模块(Main)](#主程序模块(Main))
    - [3.1 程序描述](#3.1-程序描述)
    - [3.2 功能](#3.2-功能)
    - [3.3 性能](#3.3-性能)
    - [3.4 输入项](#3.4-输入项)
    - [3.5 输出项](#3.5-输出项)
    - [3.6 算法](#3.6-算法)
    - [3.7 流程逻辑](#3.7-流程逻辑)
    - [3.8 接口](#3.8-接口)
    - [3.9 存储分配](#3.9-存储分配)
    - [3.10 限制条件](#3.10-限制条件)
- [4. 程序 2 探针输入模块(Listener) 设计说明](#4.-程序-2-探针输入模块(Listener)-设计说明)
    - [4.1 程序描述](#4.1-程序描述)
    - [4.2 功能](#4.2-功能)
    - [4.3 性能](#4.3-性能)
    - [4.4 输入项](#4.4-输入项)
    - [4.5 输出项](#4.5-输出项)
    - [4.6 算法](#4.6-算法)
    - [4.7 流程逻辑](#4.7-流程逻辑)
    - [4.8 接口](#4.8-接口)
    - [4.9 存储分配](#4.9-存储分配)
    - [4.10 注释设计](#4.10-注释设计)
    - [4.11 限制条件](#4.11-限制条件)
    - [4.12 测试计划](#4.12-测试计划)
    - [4.13 尚未解决的问题](#4.13-尚未解决的问题)
- [5. 程序 3 计算模块(Cal) 设计说明](#5.-程序-3-计算模块(Cal)-设计说明)
    - [5.1 程序描述](#5.1-程序描述)
    - [5.2 功能](#5.2-功能)
    - [5.3 性能](#5.3-性能)
    - [5.4 输入项](#5.4-输入项)
    - [5.5 输出项](#5.5-输出项)
    - [5.6 算法](#5.6-算法)
    - [5.7 流程逻辑](#5.7-流程逻辑)
    - [5.8 接口](#5.8-接口)
    - [5.9 存储分配](#5.9-存储分配)
    - [5.10 限制条件](#5.10-限制条件)
    - [5.11 测试计划](#5.11-测试计划)
    - [5.12 尚未解决的问题](#5.12-尚未解决的问题)
- [6.程序 4 查询模块(Inquiry) 设计说明](#6.程序-4-查询模块(Inquiry)-设计说明)
    - [6.1 程序描述](#6.1-程序描述)
    - [6.2 功能](#6.2-功能)
    - [6.3 性能](#6.3-性能)
    - [6.4 输入项](#6.4-输入项)
    - [6.5 输出项](#6.5-输出项)
    - [6.6 算法](#6.6-算法)
    - [6.7 流程逻辑](#6.7-流程逻辑)
    - [6.8 接口](#6.8-接口)
    - [6.11 限制条件](#6.11-限制条件)
    - [6.12 测试计划](#6.12-测试计划)
    - [6.13 尚未解决的问题](#6.13-尚未解决的问题)
- [7. 程序 5 显示模块(Monitor) 设计说明](#7.-程序-5-显示模块(Monitor)-设计说明)
    - [7.1 程序描述](#7.1-程序描述)
    - [7.2 功能](#7.2-功能)
    - [7.3 输入项](#7.3-输入项)
    - [7.4 输出项](#7.4-输出项)
    - [7.5 存储分配](#7.5-存储分配)
    - [7.6 限制条件](#7.6-限制条件)
    - [7.7 测试计划](#7.7-测试计划)
    - [7.8 尚未解决的问题](#7.8-尚未解决的问题)
- [8.程序 6 命令行显示模块(CliMonitor)设计说明](#8.程序-6-命令行显示模块(CliMonitor)设计说明)
    - [8.1 程序描述](#8.1-程序描述)
    - [8.2 功能](#8.2-功能)
    - [8.4 输入项](#8.4-输入项)
    - [8.5 输出项](#8.5-输出项)
    - [8.7 流程逻辑](#8.7-流程逻辑)
    - [8.8 接口](#8.8-接口)
    - [8.9 限制条件](#8.9-限制条件)
    - [8.10 测试计划](#8.10-测试计划)
    - [8.11 尚未解决的问题](#8.11-尚未解决的问题)
- [9.程序 7 配置模块(Config) 设计说明](#9.程序-7-配置模块(Config)-设计说明)
    - [9.1 程序描述](#9.1-程序描述)
    - [9.8 接口](#9.8-接口)
    - [9.9 存储分配](#9.9-存储分配)
    - [9.12 测试计划](#9.12-测试计划)
    - [9.13 尚未解决的问题](#9.13-尚未解决的问题)
- [10.程序 8 工具模块(Utils) 设计说明](#10.程序-8-工具模块(Utils)-设计说明)
    - [10.1 程序描述](#10.1-程序描述)
    - [10.2 功能](#10.2-功能)
    - [10.8 接口](#10.8-接口)
    - [10.9 存储分配](#10.9-存储分配)
    - [10.12 测试计划](#10.12-测试计划)
    - [10.13 尚未解决的问题](#10.13-尚未解决的问题)
﻿# 基于WIFI探针的商业大数据分析技术
## 详细设计说明书

---

## 1.引言
### 1.1 编写目的 

编写本说明书的目的是说明对程序系统的设计考虑，包括程序系统的基本处理流程、程序系统的组织结构、功能分配、模块化粉、接口设计、运行设计、数据结构设计和出错设计等，比概要设计更为详细，为编码的实现打下基础。
预期读者为：软件开发的人员，项目评审人员，及软件测试人员。
### 1.2 背景

通过对采集MAC地址数据的分析与统计，可以把握门店的客流情况，精准监控客流质量，实时展示客流转化情况，从而帮助检测营销效果，发现潜在机会和改进措施，为便捷、高效精细化运营提供全方位数据参考。
 
利用探针数据的客流分析打破模式束缚，不仅仅只是提供可信的客流数据分析，同时还利用延伸的标杆管理才能，深刻洞悉并提供有助于推动实际客流量和消费者习惯行为的一系列因素。这种专业才能呈现了经济分析，社交和环境等一些超出你控制范围的因素，却对商业绩效产生主要的冲击力。

### 1.3 定义
 - MAC：手机的唯一标识符。
 - WIFI探针技术：当一个设备给另外一个设备通过无线传输技术发送信息时，周围的其他同类设备都是能够收到这些信息的。
 - 客流量：店铺或区域整体客流及趋势。
 - 入店量：进入店铺或区域的客流及趋势
 - 入店率：进⼊店铺或区域的客流占全部客流的比例及趋势
 - 来访周期：进⼊店铺或区域的顾客距离上次来店的间隔
 - 新老顾客：一定时间段内首次/两次以上进⼊店铺的顾客
 - 顾客活跃度：按顾客距离上次来访间隔,划分为不同活跃度
 - 驻店时长：进⼊店铺的顾客在店内的停留时长
 - 跳出率：进⼊店铺后很快离店的顾客及占比(占总体客流)
 - 深访率：进⼊店铺深度访问的顾客及占⽐(占总体客流) 
 
### 1.4 参考资料
 - 刘军等著，Spark大数据处理原理、算法与实例，清华大学出版社，2016年  
 - Lars George著，HBase权威指南，人民邮电出版社，2013年 
 - 谭磊等编，Hadoop应用实践，清华大学出版社，2017年 
 - Bruce Eckel著，Scala编程思想，机械工业出版社，2016年 
 - 夏辉等编，项目软件管理，清华大学出版社，2015年
 
---

## 2. 程序系统的结构

用一系列图表列出本程序系统内的每个程序（包括每个模块和子程序）的名称、标识符和它们之间 的层次结构关系。


| 层数及编号 | 模块名称	| 程序 | 实现功能 |
|:----------:|:--------:|:----:|:--------:|
| 1 第一层   | 主模块   | Main | 实现整个系统结构 |
| 2 第一层   | 监听模块 | Listener | 接受并存储探针发送的数据 |
| 3 第二层   | 计算模块 | Cal | 实现计算逻辑 |
| 4 第三层   | 查询模块 | Inquiry | 查询计算结果 |
| 5 第四层   | 显示模块 | Monitor | 网页前台显示计算结果 |
| 6 第四层   | 命令行显示模块 | CliMonitor | 命令行显示计算结果 |
| 7 第五层   | 配置模块   | Config | 关键参数配置 |
| 8 第五层   | 工具模块   | Utils | 工具模块 |
 
 
 
 
---

## 3. 程序 1 设计说明 
### 主程序模块(Main)
### 3.1 程序描述
作为Spark程序入口，启动Spark, 启动Cal模块进行计算并输出结果.
### 3.2 功能

![http://okdlluqr1.bkt.clouddn.com/MainIPO.png][1]

### 3.3 性能 

精度要求: 正确处理全部Json数据


### 3.4 输入项
 - 输入项名称：HDFS文件
 - 类型：JSON字符串类型
 - 输入方式：HDFS读取  
 - 数据来源：Listener模块

### 3.5 输出项

输出项：客流量
数据类型：整型数据

输出项：入店量
数据类型：整型数据

输出项：来访周期
数据类型：长整形数据

输出项：新老顾客
数据类型：整型数据

输出项：驻店时长
数据类型：长整型数据

输出项：跳出率
数据类型：浮点型数据

输出项：深访率
数据类型：浮点型数据

### 3.6 算法
本程序设置Spark程序的基本参数，通过Utils模块读取HDFS中的文件，通过Cal模块进行计算并输出结果到数据库. 

### 3.7 流程逻辑 

![此处输入图片的描述][2] 

### 3.8 接口 
本程序为主程序, 调用了Utils的HDFS操作工具，Cal的启动计算接口。
 
### 3.9 存储分配
本程序的存储分配为：客流数据存入Mysql, 顾客数据存入Hbase。

### 3.10 限制条件
限制条件：本程序只能从主目录启动 


---

##  4. 程序 2 探针输入模块(Listener) 设计说明 
### 4.1 程序描述
该程序监听Web服务器的8000端口, 接收探针的数据并将其按时序存入集群.本程序为常驻内存，是子程序、可重用、是轮询处理，在收到请求之后方能进行工作.
### 4.2 功能

![此处输入图片的描述][3]
 

### 4.3 性能 
 
并发要求: 要求1000并发, 所有耗时操作为异步
精度要求: 正确处理全部字符，包括中文

### 4.4 输入项
 - 输入项名称：探针数据
  - 类型：JSON字符串类型
  - 输入方式：Wifi探针自动发送  
  - 数据来源：Wifi探针采集
  - 数量和频率：数量可支持＞１０万，使用频率 1次／3秒

### 4.5 输出项

输出项：HDFS文件
数据类型：二进制文件型
输出以文件的形式输出
 
### 4.6 算法
本程序监听服务器8000端口，接收到Wifi探针的JSON数据后，先进行验证，确认为本地探针时，将请求主体写入HDFS，文件名为时间戳加探针Mac。

### 4.7 流程逻辑
 
 ![此处输入图片的描述][4]

### 4.8 接口 
本程序随主程序同步独立运行，不提供对外接口。
 
### 4.9 存储分配
本程序的存储分配为：数据全部存入HDFS中 

### 4.10 注释设计
 - 加在模块首部的注释：本程序的目的及意义；

### 4.11 限制条件
说明本程序运行中所受到的限制条件。
限制条件：本程序中输入的用户名只支持英文字符串型或数字，不支持汉字与汉语符号。
### 4.12 测试计划
 - 并发测试
 - 错误格式JSON测试
 
### 4.13 尚未解决的问题
 - 对Json的处理和解析验证应独立为一个模块, 以适应不同的探针数据格式.
 - 需要加入线程池以缓解高并发时服务器的压力 
 
--- 


## 5. 程序 3 计算模块(Cal) 设计说明
### 5.1 程序描述
主要计算模块, 实现MapReducer逻辑.
### 5.2 功能

![此处输入图片的描述][5]

### 5.3 性能 
海量数据计算, 合理安排RDD, 避免重复RDD任务

### 5.4 输入项 
 - 输入项名称：探针数据
  - 类型：JSON字符串类型
  - 输入方式：HDFS读取  
  - 数据来源：HDFS文件 

### 5.5 输出项 
  同 3.5
### 5.6 算法
将客流数据分为两类： 

 - 面向客流：
  - 客流量：探针能探测到的客流视为客流
  - 入店量：距离小于入店距离即可视为入店
  - 入店率：入店量/客流量
  - 跳出率：在客流中未入店的部分进行上次来访时间(来访周期)的比对, 在(x)分钟内访问过的即可视为跳出 
  - 深访率：对店内客流进行驻店时长比对, 若大于(x)分钟, 可视为深访
  - 新老顾客：若数据库中没有记录, 则为新用户, 若数据库中有记录, 并且该顾客来访次数为1, 则为老用户

 - 面向单个客户：
	- 来访周期：
		+ 根据顾客表中的上次来访时间计算得到
		+ 若来访周期为0: 
			- 顾客已经在店内停留了一段时间
			- 新顾客
		+ 若来访周期不为0:
			- 顾客刚刚入店, 驻店时长必为0
		+ 显示结果时, 显示结果表中所有不为0的来访周期, 
	- 驻店时长：进入店铺的顾客在店内的停留时长
		+ 取出目标mac的所有记录, 取近似
		+ 若驻店时长为0:
			- 视为刚刚入店
		+ 显示结果时, 根据来访周期, 来选择显示的驻店时长.
	- 顾客活跃度：
	    + 按顾客距离上次来访间隔,划分为不同活跃度
		+ 显示结果时, 显示结果表中最后一次活跃度
	 

### 5.7 流程逻辑
![Cal流程][6]
 
### 5.8 接口 
本程序调用 Utils 的操作 Hdfs 接口与数据库操作接口。

### 5.9 存储分配 
 同 3.5 

### 5.10 限制条件
必须依赖 Spark 与 Hadoop 环境运行。

### 5.11 测试计划 
 - 单条数据测试
 - 多条数据测试
 - 按客流指标各项测试

### 5.12 尚未解决的问题 
 - 冗余数据的优化：大量重复Mac存在结果中，需要在存储之前优化


--- 

## 6.程序 4 查询模块(Inquiry) 设计说明
### 6.1 程序描述
通过Utils的数据库工具查询数据库结果，并处理原始计算结果，按天或按小时分割，格式化输出计算结果, 提供查询接口.

### 6.2 功能
 
 ![此处输入图片的描述][7]
  
### 6.3 性能 
查询速度要求: 响应时间不能过长, 没有明显的延迟感 
 
### 6.4 输入项 
 
 - 输入项名称：原始数据(Mac)
  - 类型：字符串数组类型
  - 输入方式：数据库读取  
  - 数据来源：Mysql， Hbase

 - 输入项名称：查询时间
  - 类型：整形
  - 输入方式：用户输入
  - 数据来源：Monitor模块输入接口 或 CLImonitor输入接口


  
### 6.5 输出项
  
 同 3.5 
 
### 6.6 算法
 - 面向客流的数据 : 
  - 在数据库中取出起止时间端内的数据, 进行map组合操作, 去重后取数据长度, 即可得到目标数据. 
 - 面向单个顾客的数据 : 
  - 从Hbase中取出前1000位访问的顾客, 清洗无效数据后返回结果.

### 6.7 流程逻辑

 ![此处输入图片的描述][8]

### 6.8 接口 
 本程序调用 Utils 的数据库操作接口。
 提供以下查询接口:  
 
  - get_results_for_day(year, month, day)
  - get_results_for_month(year, month)
  - get_result_for_mac(mac)
  - print_result(result)

### 6.11 限制条件 

需开启HbaseThriftServer才能开启查询


### 6.12 测试计划
 - 按天查询测试
 - 按月查询测试
 - Mac查询测试

### 6.13 尚未解决的问题 
 
 - 按任意时间点到时间点的查询 
 

--- 
 
 
## 7. 程序 5 显示模块(Monitor) 设计说明
### 7.1 程序描述 

提供图形用户界面, 提供查询功能, 比对功能, 后台参数设置功能.
 
### 7.2 功能 
![此处输入图片的描述][9]

### 7.3 输入项
 - 输入项名称：查询时间
  - 类型：整形
  - 输入方式：用户输入
  - 数据来源：Monitor模块输入接口 或 CLImonitor输入接口


### 7.4 输出项
 
 ![此处输入图片的描述][10]
 ![此处输入图片的描述][11]

### 7.5 存储分配
 - 配置文件 : conf.ini
 
### 7.6 限制条件
需要浏览器内核为Chrome，Firefox，IE8.0及以上


### 7.7 测试计划
 - 按天查询测试
 - 按月查询测试
 - Mac查询测试
 - 修改配置测试 

### 7.8 尚未解决的问题
 - 按任意时间点到时间点的查询 
 - 丰富图表显示内容
 - 美化用户界面


  ---

## 8.程序 6 命令行显示模块(CliMonitor)设计说明
### 8.1 程序描述 

提供命令行查询接口，方便后台测试与调试

### 8.2 功能
 
 ![此处输入图片的描述][12]
 
### 8.4 输入项

 - 输入项名称：查询时间
  - 类型：整形
  - 输入方式：用户输入
  - 数据来源：Monitor模块输入接口 或 CLImonitor输入接口
  - 示例:   

    python cli_print_result.py -y &lt;year&gt; -m  &lt;month&gt; [-d  &lt;day&gt;]
          
### 8.5 输出项 
 
输出项：客流量
数据类型：整型数据

输出项：入店量
数据类型：整型数据

输出项：新老顾客
数据类型：整型数据

输出项：跳出率
数据类型：浮点型数据

输出项：深访率
数据类型：浮点型数据
  
### 8.7 流程逻辑

![此处输入图片的描述][13]

### 8.8 接口 
 
本模块调用了Inquiry模块的 get_results_for_day 和 print_result 接口， 不对外提供接口

### 8.9 限制条件

仅供命令行终端运行，没有比对功能，显示数据格式单一

### 8.10 测试计划 
 
 - 按天查询测试
 - 按月查询测试

### 8.11 尚未解决的问题
 
  - 按任意时间点到时间点的查询 
  

---

## 9.程序 7 配置模块(Config) 设计说明
### 9.1 程序描述
 
 提供重要参数的一键修改，便于用户与运维人员管理软件，排查错误.

### 9.8 接口 
 
 提供获取参数接口 : MyConfigParser.get(section, option)
 设置参数接口 : alertConfig(dic)
 
### 9.9 存储分配
 
  - 配置文件 : conf.ini 
  
### 9.12 测试计划
 
 - 获取参数测试
 - 设置参数测试

### 9.13 尚未解决的问题

 - 权限配置，特定权限的用户仅可修改特定权限的参数


---
## 10.程序 8 工具模块(Utils) 设计说明
### 10.1 程序描述 
 
 个人开发工具, 如HDFS操作, SQL操作, 时间字符串解析等等碎片功能

### 10.2 功能 

![此处输入图片的描述][14]

### 10.8 接口 
提供以下接口：
 - HDFS存储 save_to_hdfs(json, file_name)
 - HDFS删除 delete_file(file_path)
 - HDFS遍历 get_file_paths(dir_path)

 - Mysql数据库查询 inquiry(ts_begin, ts_end)
 - Mysql数据库存储 save_results(timestamp, Result)
 - Hbase 查询 get (row_key, tableName='Customers')
 - Hbase 查询多版本 get_ver(mac, col, ver=100, tableName='Customers')
 - Hbase 遍历 scan(tableName='Customers')
 - Hbase 存储 storage(row_key, cols, tableName='Customers')

### 10.9 存储分配 

 客流数据结果存储在Mysql中
 客户数据结果存储在Hbase中
 原始数据文件存储在HDFS中

### 10.12 测试计划
 - HDFS存储测试
 - HDFS删除测试
 - HDFS遍历测试
 - Mysql数据库查询测试
 - Mysql数据库存储测试
 - Hbase 查询测试
 - Hbase 查询多版本测试
 - Hbase 遍历测试
 - Hbase 存储测试 

### 10.13 尚未解决的问题
 - 数据库的操作应单独为一个模块，以适应不同类型的数据库

 


  [1]: http://okdlluqr1.bkt.clouddn.com/MainIPO.png
  [2]: http://okdlluqr1.bkt.clouddn.com/Main%E6%B5%81%E7%A8%8B%E5%9B%BE.png
  [3]: http://okdlluqr1.bkt.clouddn.com/ListenerIPO.png
  [4]: http://okdlluqr1.bkt.clouddn.com/Listener%E6%B5%81%E7%A8%8B%E5%9B%BE.png
  [5]: http://okdlluqr1.bkt.clouddn.com/CalIPO.png
  [6]: http://okdlluqr1.bkt.clouddn.com/Cal%E6%B5%81%E7%A8%8B%E5%9B%BE.png
  [7]: http://okdlluqr1.bkt.clouddn.com/InquiryIPO.png
  [8]: http://okdlluqr1.bkt.clouddn.com/Inquiry%E6%B5%81%E7%A8%8B%E5%9B%BE.png
  [9]: http://okdlluqr1.bkt.clouddn.com/MonitorOP1.png
  [10]: http://okdlluqr1.bkt.clouddn.com/MonitorOP1.png
  [11]: http://okdlluqr1.bkt.clouddn.com/MonitorOP2.png
  [12]: http://okdlluqr1.bkt.clouddn.com/CliMonitorIPO.png
  [13]: http://okdlluqr1.bkt.clouddn.com/CLImonitor%E6%B5%81%E7%A8%8B%E5%9B%BE.png
  [14]: http://okdlluqr1.bkt.clouddn.com/Utils.png


